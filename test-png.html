<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNG è§’è‰²å¡æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #4a9eff;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-section {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #357abd;
        }

        .results {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: #1f1f1f;
            border-radius: 6px;
            border-left: 4px solid #4a9eff;
        }

        .section h3 {
            color: #4a9eff;
            margin-bottom: 10px;
        }

        .field {
            margin: 10px 0;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 4px;
        }

        .field-name {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .field-value {
            color: #e0e0e0;
            word-break: break-word;
        }

        .success {
            color: #4ade80;
        }

        .error {
            color: #f87171;
        }

        .warning {
            color: #fbbf24;
        }

        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            color: #a0a0a0;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="./index.html" style="display: inline-block; color: #888; text-decoration: none; margin-bottom: 20px; padding: 8px 12px; border-radius: 6px; transition: all 0.2s;">
            â† è¿”å›ä¸»é 
        </a>
        <h1>ğŸ” PNG è§’è‰²å¡æµ‹è¯•å·¥å…·</h1>
        
        <div class="upload-section">
            <p style="margin-bottom: 15px;">ä¸Šä¼ ä½ å¯¼å‡ºçš„ PNG è§’è‰²å¡ï¼ŒæŸ¥çœ‹é‡Œé¢çš„æ•°æ®</p>
            <input type="file" id="fileInput" accept=".png" style="display: none;">
            <button class="btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹© PNG æ–‡ä»¶</button>
        </div>

        <div id="results" class="results hidden">
            <div class="section">
                <h3>ğŸ“Š åŸºæœ¬ä¿¡æ¯</h3>
                <div id="basicInfo"></div>
            </div>

            <div class="section">
                <h3>ğŸ’¬ æ¶ˆæ¯å­—æ®µ</h3>
                <div id="messageFields"></div>
            </div>

            <div class="section">
                <h3>ğŸ“ å®Œæ•´ JSON æ•°æ®</h3>
                <pre id="fullJson"></pre>
            </div>

            <div class="section">
                <h3>ğŸ”§ åŸå§‹ Base64 æ•°æ®</h3>
                <pre id="rawBase64"></pre>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            console.log('å¼€å§‹åˆ†ææ–‡ä»¶:', file.name);

            try {
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);

                // æå– chara æ•°æ®
                const result = await extractAndAnalyze(uint8Array);

                if (result.success) {
                    displayResults(result);
                } else {
                    alert('âŒ æ— æ³•è¯»å–è§’è‰²å¡æ•°æ®: ' + result.error);
                }
            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                alert('âŒ åˆ†æå¤±è´¥: ' + error.message);
            }
        });

        async function extractAndAnalyze(pngData) {
            console.log('PNG æ–‡ä»¶å¤§å°:', pngData.length, 'bytes');

            // éªŒè¯ PNG ç­¾å
            const pngSignature = [137, 80, 78, 71, 13, 10, 26, 10];
            for (let i = 0; i < 8; i++) {
                if (pngData[i] !== pngSignature[i]) {
                    return { success: false, error: 'ä¸æ˜¯æœ‰æ•ˆçš„ PNG æ–‡ä»¶' };
                }
            }
            console.log('âœ“ PNG ç­¾åéªŒè¯é€šè¿‡');

            // æŸ¥æ‰¾ tEXt chunk
            let offset = 8;
            let charaData = null;
            let chunkCount = 0;

            while (offset < pngData.length) {
                // è¯»å– chunk é•¿åº¦
                const length = (pngData[offset] << 24) | (pngData[offset + 1] << 16) |
                    (pngData[offset + 2] << 8) | pngData[offset + 3];

                // è¯»å– chunk ç±»å‹
                const type = String.fromCharCode(
                    pngData[offset + 4],
                    pngData[offset + 5],
                    pngData[offset + 6],
                    pngData[offset + 7]
                );

                chunkCount++;
                console.log(`Chunk #${chunkCount}: ${type}, é•¿åº¦: ${length}`);

                if (type === 'tEXt') {
                    // è¯»å– tEXt æ•°æ®
                    const dataStart = offset + 8;
                    const dataEnd = dataStart + length;
                    const textData = pngData.slice(dataStart, dataEnd);

                    // æŸ¥æ‰¾ null åˆ†éš”ç¬¦
                    let nullIndex = -1;
                    for (let i = 0; i < textData.length; i++) {
                        if (textData[i] === 0) {
                            nullIndex = i;
                            break;
                        }
                    }

                    if (nullIndex !== -1) {
                        const keyword = new TextDecoder().decode(textData.slice(0, nullIndex));
                        console.log('  tEXt å…³é”®è¯:', keyword);

                        if (keyword === 'chara') {
                            const base64Data = new TextDecoder().decode(textData.slice(nullIndex + 1));
                            console.log('  âœ“ æ‰¾åˆ° chara æ•°æ®!');
                            console.log('  Base64 é•¿åº¦:', base64Data.length);
                            console.log('  Base64 å‰ 100 å­—ç¬¦:', base64Data.substring(0, 100));

                            try {
                                // è§£ç  Base64ï¼ˆæ­£ç¡®å¤„ç† UTF-8ï¼‰
                                const binaryString = atob(base64Data);
                                const bytes = new Uint8Array(binaryString.length);
                                for (let i = 0; i < binaryString.length; i++) {
                                    bytes[i] = binaryString.charCodeAt(i);
                                }
                                const jsonString = new TextDecoder().decode(bytes);
                                console.log('  JSON é•¿åº¦:', jsonString.length);
                                console.log('  JSON å‰ 200 å­—ç¬¦:', jsonString.substring(0, 200));

                                // è§£æ JSON
                                const characterCard = JSON.parse(jsonString);
                                console.log('  âœ“ JSON è§£ææˆåŠŸ');

                                charaData = {
                                    base64: base64Data,
                                    json: jsonString,
                                    parsed: characterCard
                                };
                            } catch (error) {
                                console.error('  âœ— è§£ç å¤±è´¥:', error);
                                return { success: false, error: 'è§£ç  chara æ•°æ®å¤±è´¥: ' + error.message };
                            }
                        }
                    }
                }

                // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª chunk
                offset += 12 + length; // 4(length) + 4(type) + length + 4(crc)

                if (type === 'IEND') {
                    console.log('åˆ°è¾¾ IEND chunk');
                    break;
                }
            }

            if (!charaData) {
                return { success: false, error: 'æœªæ‰¾åˆ° chara æ•°æ®' };
            }

            return { success: true, data: charaData };
        }

        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('hidden');

            const data = result.data.parsed.data || result.data.parsed;

            // åŸºæœ¬ä¿¡æ¯
            const basicInfo = document.getElementById('basicInfo');
            basicInfo.innerHTML = `
                <div class="field">
                    <div class="field-name">è§’è‰²åç§°</div>
                    <div class="field-value">${data.name || '<span class="error">æœªè®¾ç½®</span>'}</div>
                </div>
                <div class="field">
                    <div class="field-name">æ ¼å¼ç‰ˆæœ¬</div>
                    <div class="field-value">${result.data.parsed.spec || 'V1'} ${result.data.parsed.spec_version || ''}</div>
                </div>
                <div class="field">
                    <div class="field-name">åˆ›å»ºè€…</div>
                    <div class="field-value">${data.creator || '<span class="warning">æœªè®¾ç½®</span>'}</div>
                </div>
            `;

            // æ¶ˆæ¯å­—æ®µ
            const messageFields = document.getElementById('messageFields');
            const firstMesStatus = data.first_mes ? 
                `<span class="success">âœ“ å·²è®¾ç½® (${data.first_mes.length} å­—ç¬¦)</span>` : 
                `<span class="error">âœ— æœªè®¾ç½®æˆ–ä¸ºç©º</span>`;
            
            const altGreetingsStatus = data.alternate_greetings && data.alternate_greetings.length > 0 ?
                `<span class="success">âœ“ ${data.alternate_greetings.length} ä¸ª</span>` :
                `<span class="warning">æ— </span>`;

            messageFields.innerHTML = `
                <div class="field">
                    <div class="field-name">first_mes (ç¬¬ä¸€æ¡æ¶ˆæ¯)</div>
                    <div class="field-value">${firstMesStatus}</div>
                    ${data.first_mes ? `<div style="margin-top: 10px; padding: 10px; background: #1a1a1a; border-radius: 4px; color: #a0a0a0;">${escapeHtml(data.first_mes)}</div>` : ''}
                </div>
                <div class="field">
                    <div class="field-name">alternate_greetings (å¤‡ç”¨å¼€åœºç™½)</div>
                    <div class="field-value">${altGreetingsStatus}</div>
                    ${data.alternate_greetings && data.alternate_greetings.length > 0 ? 
                        data.alternate_greetings.map((g, i) => 
                            `<div style="margin-top: 10px; padding: 10px; background: #1a1a1a; border-radius: 4px; color: #a0a0a0;">
                                <strong>#${i + 1}:</strong> ${escapeHtml(g)}
                            </div>`
                        ).join('') : ''
                    }
                </div>
                <div class="field">
                    <div class="field-name">mes_example (å¯¹è¯ç¤ºä¾‹)</div>
                    <div class="field-value">${data.mes_example ? `<span class="success">âœ“ å·²è®¾ç½® (${data.mes_example.length} å­—ç¬¦)</span>` : '<span class="warning">æœªè®¾ç½®</span>'}</div>
                </div>
            `;

            // å®Œæ•´ JSON
            document.getElementById('fullJson').textContent = JSON.stringify(result.data.parsed, null, 2);

            // åŸå§‹ Base64
            document.getElementById('rawBase64').textContent = result.data.base64.substring(0, 1000) + 
                (result.data.base64.length > 1000 ? '\n\n... (å·²æˆªæ–­ï¼Œæ€»é•¿åº¦: ' + result.data.base64.length + ' å­—ç¬¦)' : '');

            console.log('=== åˆ†æå®Œæˆ ===');
            console.log('first_mes å­˜åœ¨:', !!data.first_mes);
            console.log('first_mes å†…å®¹:', data.first_mes);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
