<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å°æ¯” SillyTavern æ ¼å¼</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .side-by-side {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
        }
        h2 {
            color: #4a9eff;
            margin-top: 0;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
            max-height: 600px;
            overflow-y: auto;
        }
        .btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .highlight {
            background: #ff4444;
            color: white;
            padding: 2px 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="./index.html" id="backToHome" style="display: inline-block; color: #888; text-decoration: none; margin-bottom: 20px; padding: 8px 12px; border-radius: 6px; transition: all 0.2s;">
            â† è¿”å›ä¸»é 
        </a>
        
        <script>
            // å¦‚æœåœ¨ iframe ä¸­ï¼Œéšè—è¿”å›ä¸»é¡µé“¾æ¥
            if (window.self !== window.top) {
                const backLink = document.getElementById('backToHome');
                if (backLink) backLink.style.display = 'none';
            }
        </script>
        
        <h1>ğŸ” SillyTavern æ ¼å¼å°æ¯”å·¥å…·</h1>
        <p>ä¸Šå‚³å…©å€‹ PNG æ–‡ä»¶é€²è¡Œå°æ¯”ï¼š</p>
        <div>
            <button class="btn" onclick="document.getElementById('file1').click()">é¸æ“‡æˆ‘å€‘å°å‡ºçš„ PNG</button>
            <button class="btn" onclick="document.getElementById('file2').click()">é¸æ“‡å®˜æ–¹ PNG</button>
        </div>
        <input type="file" id="file1" accept=".png" style="display:none">
        <input type="file" id="file2" accept=".png" style="display:none">
        
        <div class="side-by-side" style="margin-top: 20px;">
            <div class="panel">
                <h2>æˆ‘å€‘çš„æ ¼å¼</h2>
                <div id="result1">ç­‰å¾…ä¸Šå‚³...</div>
            </div>
            <div class="panel">
                <h2>å®˜æ–¹æ ¼å¼</h2>
                <div id="result2">ç­‰å¾…ä¸Šå‚³...</div>
            </div>
        </div>

        <div class="panel" style="margin-top: 20px;">
            <h2>å·®ç•°åˆ†æ</h2>
            <div id="diff">ç­‰å¾…å…©å€‹æ–‡ä»¶éƒ½ä¸Šå‚³å¾Œåˆ†æ...</div>
        </div>
    </div>

    <script>
        let data1 = null;
        let data2 = null;

        document.getElementById('file1').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                data1 = await analyzeFile(file);
                displayResult('result1', data1);
                if (data1 && data2) compareDiff();
            }
        });

        document.getElementById('file2').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                data2 = await analyzeFile(file);
                displayResult('result2', data2);
                if (data1 && data2) compareDiff();
            }
        });

        async function analyzeFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // æå– chara æ•¸æ“š
                let offset = 8;
                while (offset < uint8Array.length) {
                    const length = (uint8Array[offset] << 24) | (uint8Array[offset + 1] << 16) |
                        (uint8Array[offset + 2] << 8) | uint8Array[offset + 3];
                    const type = String.fromCharCode(
                        uint8Array[offset + 4],
                        uint8Array[offset + 5],
                        uint8Array[offset + 6],
                        uint8Array[offset + 7]
                    );

                    if (type === 'tEXt') {
                        const dataStart = offset + 8;
                        const dataEnd = dataStart + length;
                        const textData = uint8Array.slice(dataStart, dataEnd);
                        
                        let nullIndex = -1;
                        for (let i = 0; i < textData.length; i++) {
                            if (textData[i] === 0) {
                                nullIndex = i;
                                break;
                            }
                        }

                        if (nullIndex !== -1) {
                            const keyword = new TextDecoder().decode(textData.slice(0, nullIndex));
                            if (keyword === 'chara') {
                                const base64Data = new TextDecoder().decode(textData.slice(nullIndex + 1));
                                
                                try {
                                    const binaryString = atob(base64Data);
                                    const bytes = new Uint8Array(binaryString.length);
                                    for (let i = 0; i < binaryString.length; i++) {
                                        bytes[i] = binaryString.charCodeAt(i);
                                    }
                                    const jsonString = new TextDecoder().decode(bytes);
                                    const parsed = JSON.parse(jsonString);
                                    
                                    return {
                                        success: true,
                                        json: jsonString,
                                        parsed: parsed,
                                        fileName: file.name
                                    };
                                } catch (e) {
                                    return { success: false, error: e.message };
                                }
                            }
                        }
                    }

                    offset += 12 + length;
                    if (type === 'IEND') break;
                }
                
                return { success: false, error: 'æœªæ‰¾åˆ° chara æ•¸æ“š' };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function displayResult(elementId, data) {
            const element = document.getElementById(elementId);
            if (!data || !data.success) {
                element.innerHTML = `<div style="color: #f87171;">éŒ¯èª¤: ${data?.error || 'æœªçŸ¥éŒ¯èª¤'}</div>`;
                return;
            }

            const obj = data.parsed.data || data.parsed;
            const info = `
                <div><strong>æ–‡ä»¶å:</strong> ${data.fileName}</div>
                <div><strong>æ ¼å¼:</strong> ${data.parsed.spec || 'V1'} ${data.parsed.spec_version || ''}</div>
                <div><strong>è§’è‰²å:</strong> ${obj.name || 'æœªè¨­ç½®'}</div>
                <div><strong>first_mes:</strong> ${obj.first_mes ? 'âœ“ (' + obj.first_mes.length + ' å­—ç¬¦)' : 'âœ— æœªè¨­ç½®'}</div>
                <div><strong>alternate_greetings:</strong> ${obj.alternate_greetings?.length || 0} å€‹</div>
                <div><strong>æ‰€æœ‰å­—æ®µ:</strong> ${Object.keys(obj).join(', ')}</div>
                <pre>${JSON.stringify(data.parsed, null, 2)}</pre>
            `;
            element.innerHTML = info;
        }

        function compareDiff() {
            if (!data1?.success || !data2?.success) return;

            const obj1 = data1.parsed.data || data1.parsed;
            const obj2 = data2.parsed.data || data2.parsed;

            const keys1 = Object.keys(obj1).sort();
            const keys2 = Object.keys(obj2).sort();

            const onlyIn1 = keys1.filter(k => !keys2.includes(k));
            const onlyIn2 = keys2.filter(k => !keys1.includes(k));
            const common = keys1.filter(k => keys2.includes(k));

            let html = '<h3>å­—æ®µå°æ¯”</h3>';
            
            if (onlyIn1.length > 0) {
                html += `<div style="color: #fbbf24;"><strong>åªåœ¨æˆ‘å€‘çš„æ ¼å¼ä¸­:</strong> ${onlyIn1.join(', ')}</div>`;
            }
            
            if (onlyIn2.length > 0) {
                html += `<div style="color: #4ade80;"><strong>åªåœ¨å®˜æ–¹æ ¼å¼ä¸­:</strong> ${onlyIn2.join(', ')}</div>`;
            }

            html += '<h3>å…±åŒå­—æ®µå€¼å°æ¯”</h3><table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #1a1a1a;"><th style="padding: 8px; text-align: left;">å­—æ®µ</th><th style="padding: 8px;">æˆ‘å€‘çš„</th><th style="padding: 8px;">å®˜æ–¹çš„</th></tr>';
            
            for (const key of common) {
                const val1 = obj1[key];
                const val2 = obj2[key];
                const type1 = typeof val1;
                const type2 = typeof val2;
                
                let display1 = type1 === 'object' ? JSON.stringify(val1).substring(0, 50) : String(val1).substring(0, 50);
                let display2 = type2 === 'object' ? JSON.stringify(val2).substring(0, 50) : String(val2).substring(0, 50);
                
                const isDiff = JSON.stringify(val1) !== JSON.stringify(val2);
                const rowStyle = isDiff ? 'background: #3a1a1a;' : '';
                
                html += `<tr style="${rowStyle}"><td style="padding: 8px;">${key}</td><td style="padding: 8px; font-size: 11px;">${display1}</td><td style="padding: 8px; font-size: 11px;">${display2}</td></tr>`;
            }
            html += '</table>';

            // æª¢æŸ¥ first_mes
            html += '<h3>first_mes è©³ç´°å°æ¯”</h3>';
            html += `<div><strong>æˆ‘å€‘çš„ first_mes:</strong> "${obj1.first_mes}"</div>`;
            html += `<div><strong>å®˜æ–¹çš„ first_mes:</strong> "${obj2.first_mes}"</div>`;
            html += `<div><strong>é•·åº¦:</strong> æˆ‘å€‘ ${obj1.first_mes?.length || 0} vs å®˜æ–¹ ${obj2.first_mes?.length || 0}</div>`;

            document.getElementById('diff').innerHTML = html;
        }
    </script>
</body>
</html>
